/*

Esta query tiene como objetivo obtener una tabla final 
con las geometr√≠as, los nombres, y el valor de vulnerabilidad
espacial [0,1]  

*/

-- se elimina la capa de ruteo
DROP TABLE IF EXISTS capas_estaticas.social_vulnerability_robust_scaling;

-- se crea la capa de ruteo
CREATE TABLE capas_estaticas.social_vulnerability_robust_scaling as 

WITH manzanas AS (
    SELECT
        id,
        personas,
        pobl_depend,
        geom as geom
    FROM 
        capas_estaticas."social_vulnerability"
    --WHERE
    --    "DE_0_A_5_A" <> 'Indeterminado'
    --    AND "DE_65_MAS_" <> 'Indeterminado'
),


stats as (
  SELECT
    percentile_cont(0.5) WITHIN GROUP (ORDER BY personas) AS median_personas,
    percentile_cont(0.25) WITHIN GROUP (ORDER BY personas) AS q1_personas,
    percentile_cont(0.75) WITHIN GROUP (ORDER BY personas) AS q3_personas,
    percentile_cont(0.5) WITHIN GROUP (ORDER BY pobl_depend) AS median_pobl_depend,
    percentile_cont(0.25) WITHIN GROUP (ORDER BY pobl_depend) AS q1_pobl_depend,
    percentile_cont(0.75) WITHIN GROUP (ORDER BY pobl_depend) AS q3_pobl_depend
  FROM manzanas
)


SELECT
    id, 
    personas, 
    pobl_depend,
    (manzanas.personas - stats.median_personas) / (stats.q3_personas - stats.q1_personas) AS personas_robust_scaled,
    (manzanas.pobl_depend - stats.median_pobl_depend) / (stats.q3_pobl_depend - stats.q1_pobl_depend) AS pobl_depend_robust_scaled,
    geom
FROM
  manzanas, stats