/*
Esta query tiene como objetivo obtener una tabla final 
con las geometr√≠as, los nombres, y el valor de vulnerabilidad
espacial [0,1]  

*/


-- se elimina la capa de ruteo
DROP TABLE IF EXISTS capas_estaticas.economic_vulnerability_robust_scaling;

-- se crea la capa de ruteo
CREATE TABLE capas_estaticas.economic_vulnerability_robust_scaling as 

WITH entidades_18s as (
    SELECT
        id,
        conteo_sii,
        conteo_plantas,
        entidad_geom
    FROM 
        capas_estaticas."economic_vulnerability"
),

stats as (
  SELECT
    percentile_cont(0.5) WITHIN GROUP (ORDER BY conteo_sii) AS median_conteo_sii,
    percentile_cont(0.25) WITHIN GROUP (ORDER BY conteo_sii) AS q1_conteo_sii,
    percentile_cont(0.75) WITHIN GROUP (ORDER BY conteo_sii) AS q3_conteo_sii,
    percentile_cont(0.5) WITHIN GROUP (ORDER BY conteo_plantas) AS median_conteo_plantas,
    percentile_cont(0.25) WITHIN GROUP (ORDER BY conteo_plantas) AS q1_conteo_plantas,
    percentile_cont(0.75) WITHIN GROUP (ORDER BY conteo_plantas) AS q3_conteo_plantas
  FROM entidades_18s
)


SELECT
	id,
    conteo_sii,
    conteo_plantas,
    (entidades_18s.conteo_sii - stats.median_conteo_sii) / (stats.q3_conteo_sii - stats.q1_conteo_sii) AS conteo_sii_robust_scaled,
    (entidades_18s.conteo_plantas - stats.median_conteo_plantas) / (stats.q3_conteo_plantas - stats.q1_conteo_plantas) AS conteo_plantas_robust_scaled,
    entidad_geom
FROM 
    entidades_18s, stats

