/*
Esta query tiene como objetivo obtener una tabla final 
con las geometrías, los nombres, y el valor de vulnerabilidad
espacial [0,1]  

*/


-- se elimina la capa de ruteo
DROP TABLE IF EXISTS capas_estaticas.economic_vulnerability;

-- se crea la capa de ruteo
CREATE TABLE capas_estaticas.economic_vulnerability as 

WITH entidades_18s as (
    SELECT
        id,
        ST_Transform(geom, 32718) AS geom
    FROM 
        capas_estaticas."social_vulnerability"
),

plantas_18s as (
    SELECT
        ST_Transform(geom, 32718) AS geom
    FROM
        capas_estaticas."merge_plantas"
),

empresas_18s as (
    SELECT
        ST_Transform(geom, 32718) AS geom
    FROM
        capas_estaticas."business_location_filtered"
),

empresas_sii as (
    SELECT
        entidad.id,
        entidad.geom AS entidad_geom,
        COUNT(empresas.geom) AS conteo_sii
    FROM 
        entidades_18s as entidad
    LEFT JOIN 
        empresas_18s AS empresas
    ON 
        ST_DWithin(entidad.geom,  empresas.geom, 500)
    GROUP BY
        entidad.id, entidad.geom
),

final_empresas_sii as (
    SELECT 
        id,
        entidad_geom,
        conteo_sii
    FROM empresas_sii
),

ingresos_plantas as (
    SELECT
        entidad.id,
        entidad.entidad_geom,
        COUNT(plantas.geom) AS conteo_plantas
    FROM 
        final_empresas_sii as entidad
    LEFT JOIN 
        plantas_18s AS plantas
    ON 
        ST_DWithin(entidad.entidad_geom, plantas.geom, 10000)
    GROUP BY
        entidad.id, entidad.entidad_geom
),

final_plantas as (
    SELECT 
        id,
        conteo_plantas
    FROM ingresos_plantas
),

join_empresas_plantas as (
    SELECT 
        final_empresas_sii.id,
        final_empresas_sii.entidad_geom,
        final_empresas_sii.conteo_sii,
        final_plantas.conteo_plantas
    FROM
        final_empresas_sii
    LEFT JOIN
        final_plantas
    ON final_empresas_sii.id = final_plantas.id
),

cast_values_entidad as (
    SELECT
        id,
        CAST(conteo_sii as numeric) as conteo_sii,
        CAST(conteo_plantas as numeric) as conteo_plantas,
        entidad_geom
    FROM	
		join_empresas_plantas
),

-- Calcular el valor mínimo y máximo de la columna "poblacion"
min_max_entidad AS (
    SELECT
        MIN(conteo_sii) AS min_sii,
        MAX(conteo_sii) AS max_sii, 
        MIN(conteo_plantas) AS min_plantas,
        MAX(conteo_plantas) AS max_plantas
    FROM 
		cast_values_entidad
),

final_entidad as (
    SELECT
		id,
        conteo_sii,
        conteo_plantas,
        (entidad.conteo_sii - min_sii) / (max_sii - min_sii) as sii_norm,
        (entidad.conteo_plantas - min_plantas) / (max_plantas - min_plantas) as plantas_norm,
        entidad_geom
    FROM cast_values_entidad as entidad, min_max_entidad as min_max 
)

SELECT
	id,
    conteo_sii,
    conteo_plantas,
    sii_norm,
    plantas_norm,
    entidad_geom
FROM 
    final_entidad

