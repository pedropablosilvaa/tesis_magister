/*

Esta query tiene como objetivo obtener una tabla final 
con las geometrías, los nombres, y el valor de vulnerabilidad
espacial [0,1]  

*/

-- se elimina la capa de ruteo
DROP TABLE IF EXISTS capas_estaticas.social_vulnerability_normalized;

-- se crea la capa de ruteo
CREATE TABLE capas_estaticas.social_vulnerability_normalized as 

WITH manzanas AS (
    SELECT
        Id,
        personas,
        pobl_depend,
        geom as geom
    FROM 
        capas_estaticas."social_vulnerability"
    --WHERE
    --    "DE_0_A_5_A" <> 'Indeterminado'
    --    AND "DE_65_MAS_" <> 'Indeterminado'
),

-- Calcular el valor mínimo y máximo de la columna "poblacion"
min_max_entidad AS (
    SELECT
        CAST(MIN(pobl_depend) as numeric) AS min_pobl_depend,
        CAST(MAX(pobl_depend) as numeric) AS max_pobl_depend,
        CAST(MIN(personas) as numeric) AS min_personas,
        CAST(MAX(personas) as numeric) AS max_personas
    FROM 
		manzanas
),

final_entidad as (
    SELECT
		id,
        personas,
        pobl_depend,
        (entidad.pobl_depend - min_pobl_depend) / (max_pobl_depend - min_pobl_depend) as pobl_depend_norm,
        (entidad.personas - min_personas) / (max_personas - min_personas) as personas_norm,
        geom
    FROM manzanas as entidad, min_max_entidad 
)

SELECT
*
FROM 
    final_entidad


