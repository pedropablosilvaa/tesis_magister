/*
Esta query tiene como objetivo obtener una tabla final 
con las geometrÃ­as, los nombres, y el valor de vulnerabilidad
espacial [0,1]  

*/

-- se elimina la capa de ruteo
DROP TABLE IF EXISTS capas_estaticas.economic_vulnerability;

-- se crea la capa de ruteo
CREATE TABLE capas_estaticas.economic_vulnerability as 


WITH entidades_18s as (
    SELECT
        id,
        ST_Transform(geom, 32718) AS geom
    FROM 
        capas_estaticas."social_vulnerability"
),

plantas_18s as (
    SELECT
        ST_Transform(geom, 32718) AS geom
    FROM
        capas_estaticas."listado_plantas"
),

empresas_18s as (
    SELECT
        ST_Transform(geom, 32718) AS geom
    FROM
        capas_estaticas."business_location_filtered"
),

empresas_sii as (
    SELECT
        entidad.id,
        entidad.geom AS entidad_geom,
        COUNT(empresas.geom) AS conteo_sii
    FROM 
        entidades_18s as entidad
    LEFT JOIN 
        empresas_18s AS empresas
    ON 
        ST_DWithin(entidad.geom,  empresas.geom, 1000)
    GROUP BY
        entidad.id, entidad.geom
),

final_empresas_sii as (
    SELECT 
        id,
        entidad_geom,
        conteo_sii
    FROM empresas_sii
),

ingresos_plantas as (
    SELECT
        entidad.id,
        entidad.entidad_geom,
        COUNT(plantas.geom) AS conteo_plantas
    FROM 
        final_empresas_sii as entidad
    LEFT JOIN 
        plantas_18s AS plantas
    ON 
        ST_DWithin(entidad.entidad_geom, plantas.geom, 10000)
    GROUP BY
        entidad.id, entidad.entidad_geom
),

final_plantas as (
    SELECT 
        id,
        conteo_plantas
    FROM ingresos_plantas
),

join_empresas_plantas as (
    SELECT 
        final_empresas_sii.id,
        final_empresas_sii.entidad_geom,
        final_empresas_sii.conteo_sii,
        final_plantas.conteo_plantas
    FROM
        final_empresas_sii
    LEFT JOIN
        final_plantas
    ON final_empresas_sii.id = final_plantas.id
),

cast_values_entidad as (
    SELECT
        id,
        CAST(conteo_sii as numeric) as conteo_sii,
        CAST(conteo_plantas as numeric) as conteo_plantas,
        entidad_geom
    FROM	
		join_empresas_plantas
),

final_entidad as (
    SELECT
		id,
        conteo_sii,
        conteo_plantas,
        CASE 
            WHEN conteo_sii  = 0 THEN 0.074
            WHEN (conteo_sii  > 0 AND conteo_sii < 13) THEN 0.138
            WHEN (conteo_sii  >= 13 AND conteo_sii < 17) THEN 0.275
            WHEN (conteo_sii  >= 17) THEN 0.512
        END AS conteo_sii_weighted,
        CASE 
            WHEN conteo_plantas = 0 THEN 0.057
            WHEN (conteo_plantas  = 1) THEN 0.122
            WHEN (conteo_plantas  = 2 ) THEN 0.263
            WHEN (conteo_plantas  > 2) THEN 0.558
        END AS conteo_plantas_weighted,
        entidad_geom
    FROM cast_values_entidad as entidad
)

SELECT
	id,
    conteo_sii,
    conteo_plantas,
    conteo_sii_weighted,
    conteo_plantas_weighted,
    entidad_geom
FROM 
    final_entidad

