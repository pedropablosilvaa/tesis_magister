/*

Esta query tiene como objetivo obtener una tabla final 
con las geometrías, los nombres, y el valor de vulnerabilidad
espacial [0,1]  

*/


-- se elimina la capa de ruteo
DROP TABLE IF EXISTS capas_estaticas.social_vulnerability;


-- se crea la capa de ruteo
CREATE TABLE capas_estaticas.social_vulnerability as 



---------------------------- Manzanas --------------------------------------



-- se traen las manzanas con la informacion censal
WITH manzanas AS (
    SELECT
        "FID" as id,
        "COD_ENTIDA" as cod_entidad,
        "PROVINCIA" as provincia,
        "COMUNA" as comuna,
        "PERSONAS" as personas,
        "DE_0_A_5_A" as edad_0_5,
        "DE_6_A_14_" as edad_6_14,
        "DE_65_MAS_" as edad_65_mas,
        geom as geom
    FROM 
        capas_estaticas."censo_2017_XR"
    --WHERE
    --    "DE_0_A_5_A" <> 'Indeterminado'
    --    AND "DE_65_MAS_" <> 'Indeterminado'
),

-- se cambian los valores Indeterminado por 0 (text)
clean_population_manz  as (
    SELECT
        id,
        cod_entidad,
        provincia,
        comuna,
        personas,
        CASE 
            WHEN edad_0_5 = 'Indeterminado' THEN '0'
            ELSE edad_0_5
        END AS edad_0_5,
        CASE 
            WHEN edad_6_14 = 'Indeterminado' THEN '0'
            ELSE edad_6_14
        END AS edad_6_14,
        CASE 
            WHEN edad_65_mas = 'Indeterminado' THEN '0'
            ELSE edad_65_mas
        END AS edad_65_mas,
        geom
    FROM	
		manzanas

),

-- las columnas con informacion censal se "castean" a numerico
cast_values_manz as (
    SELECT
        id,
        personas,
        CAST(edad_0_5 as NUMERIC),
        CAST(edad_6_14 as NUMERIC),
        CAST(edad_65_mas as NUMERIC),
        geom

    FROM 
        clean_population_manz
),

-- se suman las personas para determinar la poblacion dependiente
sum_values_manz as (
    SELECT 
        id,
        personas,
        SUM(edad_0_5 + edad_6_14 + edad_65_mas) as pobl_depend,
        geom
    FROM 
        cast_values_manz
    GROUP BY
        id, personas, geom
),

-- se obtienen todas las manzanas y se les agregan los pesos.
final_manz as (
    SELECT
		id,
        personas,
        pobl_depend,
        CASE 
            WHEN personas  < 30 THEN 0.05
            WHEN (personas  >= 30 AND personas < 50) THEN 0.105
            WHEN (personas  >= 50 AND personas < 90) THEN 0.243
            WHEN (personas  >= 90) THEN 0.602
        END AS personas_weighted,
        CASE 
            WHEN pobl_depend  < 5 THEN 0.047
            WHEN (pobl_depend  >=  5 AND pobl_depend < 10) THEN 0.077
            WHEN (pobl_depend  >= 10 AND pobl_depend < 25) THEN 0.259
            WHEN (pobl_depend  >= 25) THEN 0.617
        END AS pobl_depend_weighted,
        geom
    FROM sum_values_manz 
),



---------------------------- Entidades --------------------------------------


-- se traen las entidades
entidad AS (
    SELECT
        "FID" as id,
        "PERSONAS" as personas,
        "DE_0_A_5_A" as edad_0_5,
        "DE_6_A_14_" as edad_6_14,
        "DE_65_MAS_" as edad_65_mas,
        geom as geom
    FROM 
        capas_estaticas."entidades_2017_XR"
    --WHERE
    --    "DE_0_A_5_A" <> 'Indeterminado'
    --    AND "DE_65_MAS_" <> 'Indeterminado'
),

-- se cambian los valores Indeterminado por 0 (text)
clean_population_entidad  as (
    SELECT
        id,
        personas,
        CASE 
            WHEN edad_0_5 = 'Indeterminado' THEN '0'
            ELSE edad_0_5
        END AS edad_0_5,
        CASE 
            WHEN edad_6_14 = 'Indeterminado' THEN '0'
            ELSE edad_6_14
        END AS edad_6_14,
        CASE 
            WHEN edad_65_mas = 'Indeterminado' THEN '0'
            ELSE edad_65_mas
        END AS edad_65_mas,
        geom
    FROM	
		entidad

),

-- las columnas con informacion censal se "castean" a numerico
cast_values_entidad as (
    SELECT
        id,
        CAST(personas as NUMERIC) as personas,
        CAST(edad_0_5 as NUMERIC) as edad_0_5,
        CAST(edad_6_14 as NUMERIC) as edad_6_14,
        CAST(edad_65_mas as NUMERIC) edad_65_mas,
        geom
    FROM	
		clean_population_entidad
),

-- se suman las edades económicamente dependiente
sum_values_entidad as (
    SELECT
        id, 
        personas, 
        SUM(edad_0_5 + edad_6_14 + edad_65_mas) as pobl_depend,
        geom
    FROM 
        cast_values_entidad
    GROUP BY
        id, personas, geom
),

-- se agregan los pesos a las personas y a la poblacion dependiente
final_entidad as (
    SELECT
		id,
        personas,
        pobl_depend,
        CASE 
            WHEN personas  < 30 THEN 0.05
            WHEN (personas  >= 30 AND personas < 50) THEN 0.105
            WHEN (personas  >= 50 AND personas < 90) THEN 0.243
            WHEN (personas  >= 90) THEN 0.602
        END AS personas_weighted,
        CASE 
            WHEN pobl_depend  < 5 THEN 0.047
            WHEN (pobl_depend  >=  5 AND pobl_depend < 10) THEN 0.077
            WHEN (pobl_depend  >= 10 AND pobl_depend < 25) THEN 0.259
            WHEN (pobl_depend  >= 25) THEN 0.617
        END AS pobl_depend_weighted,
        geom
    FROM sum_values_entidad 
)


-- final c:
SELECT
id,
personas,
pobl_depend,
personas_weighted,
pobl_depend_weighted,
geom
FROM 
    final_entidad
UNION ALL
SELECT * FROM final_manz


