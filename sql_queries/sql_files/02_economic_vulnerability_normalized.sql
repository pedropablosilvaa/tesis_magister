/*
Esta query tiene como objetivo obtener una tabla final 
con las geometrías, los nombres, y el valor de vulnerabilidad
espacial [0,1]  

*/


-- se elimina la capa de ruteo
DROP TABLE IF EXISTS capas_estaticas.economic_vulnerability_normalized;

-- se crea la capa de ruteo
CREATE TABLE capas_estaticas.economic_vulnerability_normalized as 

WITH entidades_18s as (
    SELECT
        id,
        conteo_sii,
        conteo_plantas,
        entidad_geom
    FROM 
        capas_estaticas."economic_vulnerability"
),

-- Calcular el valor mínimo y máximo de la columna "poblacion"
min_max_entidad AS (
    SELECT
        MIN(conteo_sii) AS min_sii,
        MAX(conteo_sii) AS max_sii, 
        MIN(conteo_plantas) AS min_plantas,
        MAX(conteo_plantas) AS max_plantas
    FROM 
		entidades_18s
),

final_entidad as (
    SELECT
		id,
        conteo_sii,
        conteo_plantas,
        (entidad.conteo_sii - min_sii) / (max_sii - min_sii) as sii_norm,
        (entidad.conteo_plantas - min_plantas) / (max_plantas - min_plantas) as plantas_norm,
        entidad_geom
    FROM entidades_18s as entidad, min_max_entidad as min_max 
)

SELECT
	id,
    conteo_sii,
    conteo_plantas,
    sii_norm,
    plantas_norm,
    entidad_geom
FROM 
    final_entidad

